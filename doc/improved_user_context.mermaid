graph TB
    %% ===== USER MANAGEMENT CONTEXT =====
    subgraph UserContext ["ğŸ‘¤ User Management Context"]
        
        %% ===== APPLICATION SERVICE LAYER =====
        subgraph UserApplicationLayer ["Application Service Layer <<Application>>"]
            UserApplicationService["ğŸ‘¤ User Application Service<br/><<ApplicationService>>"]
            
            %% Commands
            subgraph UserCommands ["Commands"]
                CreateUserCmd["â• Create User<br/><<Command>>"]
                UpdateUserCmd["âœï¸ Update User<br/><<Command>>"]
                DeactivateUserCmd["ğŸš« Deactivate User<br/><<Command>>"]
                ChangePasswordCmd["ğŸ”’ Change Password<br/><<Command>>"]
                AddFavoriteCmd["â¤ï¸ Add Favorite<br/><<Command>>"]
                RecordActivityCmd["ğŸ“Š Record Activity<br/><<Command>>"]
            end
            
            %% Queries
            subgraph UserQueries ["Queries"]
                GetUserQuery["ğŸ‘¤ Get User<br/><<Query>>"]
                GetUserActivityQuery["ğŸ“Š Get Activity<br/><<Query>>"]
                GetUserFavoritesQuery["â¤ï¸ Get Favorites<br/><<Query>>"]
                GetUserStatsQuery["ğŸ“ˆ Get Stats<br/><<Query>>"]
            end
            
            %% Sagas
            subgraph UserSagas ["Sagas"]
                UserOnboardingSaga["ğŸ¯ User Onboarding<br/><<Saga>>"]
                UserDeactivationSaga["ğŸš« User Deactivation<br/><<Saga>>"]
            end
        end
        
        %% ===== DOMAIN LAYER (HEXAGON CORE) =====
        subgraph UserDomain ["Domain Layer <<DomainCore>>"]
            direction TB
            
            %% Aggregates
            User["ğŸ‘¤ User<br/><<AggregateRoot>>"]
            UserActivity["ğŸ“Š Activity<br/><<AggregateRoot>>"]
            UserFavorites["â¤ï¸ Favorites<br/><<AggregateRoot>>"]
            
            %% Entities
            RefreshToken["ğŸ« Refresh Token<br/><<Entity>>"]
            DeviceToken["ğŸ“± Device Token<br/><<Entity>>"]
            ActivityEntry["ğŸ“ Activity Entry<br/><<Entity>>"]
            Role["ğŸ­ Role<br/><<Entity>>"]
            
            %% Value Objects
            UserId["ğŸ†” User ID<br/><<ValueObject>>"]
            Email["ğŸ“§ Email<br/><<ValueObject>>"]
            UserName["ğŸ‘¤ User Name<br/><<ValueObject>>"]
            
            %% Domain Services
            UserValidationService["âœ… User Validation<br/><<DomainService>>"]
            ActivityTrackingService["ğŸ“Š Activity Tracking<br/><<DomainService>>"]
        end
        
        %% ===== PORTS (DOMAIN INTERFACES) =====
        subgraph UserPorts ["Ports <<Port>>"]
            direction TB
            
            %% Repository Ports
            IUserRepo["ğŸ‘¤ IUserRepository<br/><<Port>>"]
            IActivityRepo["ğŸ“Š IActivityRepository<br/><<Port>>"]
            IFavoriteRepo["â¤ï¸ IFavoriteRepository<br/><<Port>>"]
            ITokenRepo["ğŸ« ITokenRepository<br/><<Port>>"]
            IRoleRepo["ğŸ­ IRoleRepository<br/><<Port>>"]
            
            %% Service Ports
            IPasswordHasher["ğŸ”’ IPasswordHasher<br/><<Port>>"]
            IEmailService["ğŸ“§ IEmailService<br/><<Port>>"]
            IStorageService["ğŸ’¾ IStorageService<br/><<Port>>"]
            INotificationService["ğŸ”” INotificationService<br/><<Port>>"]
            IIdentityService["ğŸ†” IIdentityService<br/><<Port>>"]
        end
        
        %% ===== INFRASTRUCTURE LAYER (ADAPTERS) =====
        subgraph UserAdapters ["Infrastructure Layer <<Adapter>>"]
            direction TB
            
            %% Repository Adapters
            subgraph UserRepositoryAdapters ["Repository Adapters"]
                MongoUserRepo["ğŸ—„ï¸ Mongo User Repository<br/><<RepositoryAdapter>>"]
                MongoActivityRepo["ğŸ—„ï¸ Mongo Activity Repository<br/><<RepositoryAdapter>>"]
                MongoFavoriteRepo["ğŸ—„ï¸ Mongo Favorite Repository<br/><<RepositoryAdapter>>"]
                RedisTokenRepo["ğŸ”´ Redis Token Repository<br/><<RepositoryAdapter>>"]
                MongoRoleRepo["ğŸ—„ï¸ Mongo Role Repository<br/><<RepositoryAdapter>>"]
            end
            
            %% Service Adapters
            subgraph UserServiceAdapters ["Service Adapters"]
                BcryptHasher["ğŸ” Bcrypt Hasher<br/><<SecurityAdapter>>"]
                SendGridEmail["ğŸ“§ SendGrid Email<br/><<EmailAdapter>>"]
                S3Storage["â˜ï¸ S3 Storage<br/><<StorageAdapter>>"]
                FirebasePush["ğŸ“± Firebase Push<br/><<NotificationAdapter>>"]
                IdentityContextAdapter["ğŸ†” Identity Context<br/><<ContextAdapter>>"]
            end
            
            %% Cache Adapters
            subgraph UserCacheAdapters ["Cache Adapters"]
                UserProfileCache["ğŸ’¾ User Profile Cache<br/><<CacheAdapter>>"]
                ActivityCache["ğŸ’¾ Activity Cache<br/><<CacheAdapter>>"]
            end
        end
        
        %% ===== CONTEXT BUS INTERFACES =====
        subgraph UserContextBus ["Context Bus Interfaces"]
            UserCommandBus["âš¡ User Command Bus<br/><<CommandBus>>"]
            UserQueryBus["â“ User Query Bus<br/><<QueryBus>>"]
            UserEventBus["ğŸ“¨ User Event Bus<br/><<EventBus>>"]
        end
    end
    
    %% ===== EXTERNAL SYSTEMS =====
    subgraph UserExternal ["ğŸŒ External Systems"]
        MongoDB["ğŸ—„ï¸ MongoDB<br/><<Database>>"]
        RedisCache["ğŸ”´ Redis<br/><<Cache>>"]
        S3Bucket["â˜ï¸ S3 Bucket<br/><<Storage>>"]
        SendGridAPI["ğŸ“§ SendGrid API<br/><<EmailService>>"]
        FirebaseAPI["ğŸ“± Firebase API<br/><<PushService>>"]
    end
    
    %% ===== EVENTS =====
    subgraph UserEvents ["ğŸ“¨ Domain Events"]
        UserRegisteredEvent["ğŸ‘¤ User Registered<br/><<DomainEvent>>"]
        UserUpdatedEvent["âœï¸ User Updated<br/><<DomainEvent>>"]
        UserDeactivatedEvent["ğŸš« User Deactivated<br/><<DomainEvent>>"]
        ActivityRecordedEvent["ğŸ“Š Activity Recorded<br/><<DomainEvent>>"]
        FavoriteAddedEvent["â¤ï¸ Favorite Added<br/><<DomainEvent>>"]
    end
    
    %% ===== READ MODELS =====
    subgraph UserReadModels ["ğŸ“Š Read Models"]
        UserProfileRM["ğŸ‘¤ User Profile<br/><<ReadModel>>"]
        UserDashboardRM["ğŸ“Š User Dashboard<br/><<ReadModel>>"]
        UserActivityRM["ğŸ“ˆ User Activity<br/><<ReadModel>>"]
        UserStatsRM["ğŸ“Š User Stats<br/><<ReadModel>>"]
    end
    
    %% ===== EXTERNAL CONTEXT REFERENCES =====
    subgraph ExternalContexts ["ğŸŒ External Contexts"]
        IdentityContext["ğŸ†” Identity Context<br/><<ExternalContext>>"]
        NotificationContext["ğŸ”” Notification Context<br/><<ExternalContext>>"]
        OrganizationContext["ğŸ¢ Organization Context<br/><<ExternalContext>>"]
    end
    
    %% ===== RELATIONSHIPS =====
    
    %% Application Service orchestrates everything
    UserApplicationService --> UserCommandBus
    UserApplicationService --> UserQueryBus
    UserApplicationService --> UserEventBus
    
    %% Commands and Queries through Application Service
    UserCommands --> UserApplicationService
    UserQueries --> UserApplicationService
    UserSagas --> UserApplicationService
    
    %% Application Service to Domain (orchestration)
    UserApplicationService --> User
    UserApplicationService --> UserActivity
    UserApplicationService --> UserFavorites
    UserApplicationService --> UserValidationService
    UserApplicationService --> ActivityTrackingService
    
    %% Domain to Ports (Dependency Inversion)
    User -->|uses| IUserRepo
    User -->|uses| IPasswordHasher
    User -->|uses| IEmailService
    User -->|uses| IIdentityService
    UserActivity -->|uses| IActivityRepo
    UserFavorites -->|uses| IFavoriteRepo
    ActivityTrackingService -->|uses| INotificationService
    
    %% Ports to Adapters (Implementation)
    IUserRepo -.->|implements| MongoUserRepo
    IActivityRepo -.->|implements| MongoActivityRepo
    IFavoriteRepo -.->|implements| MongoFavoriteRepo
    ITokenRepo -.->|implements| RedisTokenRepo
    IRoleRepo -.->|implements| MongoRoleRepo
    IPasswordHasher -.->|implements| BcryptHasher
    IEmailService -.->|implements| SendGridEmail
    IStorageService -.->|implements| S3Storage
    INotificationService -.->|implements| FirebasePush
    IIdentityService -.->|implements| IdentityContextAdapter
    
    %% Adapters to External Systems
    MongoUserRepo -->|connects| MongoDB
    MongoActivityRepo -->|connects| MongoDB
    MongoFavoriteRepo -->|connects| MongoDB
    MongoRoleRepo -->|connects| MongoDB
    RedisTokenRepo -->|connects| RedisCache
    UserProfileCache -->|connects| RedisCache
    ActivityCache -->|connects| RedisCache
    S3Storage -->|connects| S3Bucket
    SendGridEmail -->|connects| SendGridAPI
    FirebasePush -->|connects| FirebaseAPI
    
    %% Cross-Context Communication
    IdentityContextAdapter -.->|async calls| IdentityContext
    FirebasePush -.->|async calls| NotificationContext
    
    %% Domain Events
    User -.->|publishes| UserRegisteredEvent
    User -.->|publishes| UserUpdatedEvent
    User -.->|publishes| UserDeactivatedEvent
    UserActivity -.->|publishes| ActivityRecordedEvent
    UserFavorites -.->|publishes| FavoriteAddedEvent
    
    %% Event to Read Models (via Event Bus)
    UserEventBus -.->|projects to| UserProfileRM
    UserEventBus -.->|projects to| UserDashboardRM
    UserEventBus -.->|projects to| UserActivityRM
    UserEventBus -.->|projects to| UserStatsRM
    
    %% Events to Event Bus
    UserRegisteredEvent -.->|publishes to| UserEventBus
    UserUpdatedEvent -.->|publishes to| UserEventBus
    UserDeactivatedEvent -.->|publishes to| UserEventBus
    ActivityRecordedEvent -.->|publishes to| UserEventBus
    FavoriteAddedEvent -.->|publishes to| UserEventBus
    
    %% Sagas listen to events
    UserOnboardingSaga -.->|listens to| UserRegisteredEvent
    UserDeactivationSaga -.->|listens to| UserDeactivatedEvent
    
    %% Context Bus to External Event Bus
    UserEventBus -.->|integrates with| ExternalContexts
    
    %% ===== STYLING =====
    classDef aggregate fill:#e1f5fe,stroke:#01579b,stroke-width:3px
    classDef entity fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef valueObject fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef port fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef adapter fill:#fff8e1,stroke:#f57f17,stroke-width:2px
    classDef external fill:#fafafa,stroke:#424242,stroke-width:2px
    classDef command fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef query fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef event fill:#f1f8e9,stroke:#33691e,stroke-width:2px
    classDef readModel fill:#e0f2f1,stroke:#00695c,stroke-width:2px
    classDef externalContext fill:#f5f5f5,stroke:#757575,stroke-width:2px,stroke-dasharray: 5 5
    classDef applicationService fill:#e3f2fd,stroke:#0277bd,stroke-width:4px
    classDef contextBus fill:#fff9c4,stroke:#f9a825,stroke-width:2px
    
    class User,UserActivity,UserFavorites aggregate
    class RefreshToken,DeviceToken,ActivityEntry,Role entity
    class UserId,Email,UserName valueObject
    class IUserRepo,IActivityRepo,IFavoriteRepo,ITokenRepo,IRoleRepo,IPasswordHasher,IEmailService,IStorageService,INotificationService,IIdentityService port
    class MongoUserRepo,MongoActivityRepo,MongoFavoriteRepo,RedisTokenRepo,MongoRoleRepo,BcryptHasher,SendGridEmail,S3Storage,FirebasePush,IdentityContextAdapter,UserProfileCache,ActivityCache adapter
    class MongoDB,RedisCache,S3Bucket,SendGridAPI,FirebaseAPI external
    class CreateUserCmd,UpdateUserCmd,DeactivateUserCmd,ChangePasswordCmd,AddFavoriteCmd,RecordActivityCmd command
    class GetUserQuery,GetUserActivityQuery,GetUserFavoritesQuery,GetUserStatsQuery query
    class UserRegisteredEvent,UserUpdatedEvent,UserDeactivatedEvent,ActivityRecordedEvent,FavoriteAddedEvent event
    class UserProfileRM,UserDashboardRM,UserActivityRM,UserStatsRM readModel
    class IdentityContext,NotificationContext,OrganizationContext externalContext
    class UserApplicationService applicationService
    class UserCommandBus,UserQueryBus,UserEventBus contextBus