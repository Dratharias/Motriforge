graph TB
    %% ===== USER MANAGEMENT CONTEXT =====
    subgraph UserContext ["👤 User Management Context"]
        
        %% ===== DOMAIN LAYER (HEXAGON CORE) =====
        subgraph UserDomain ["Domain Layer <<DomainCore>>"]
            direction TB
            
            %% Aggregates
            User["👤 User<br/><<AggregateRoot>>"]
            UserActivity["📊 Activity<br/><<AggregateRoot>>"]
            UserFavorites["❤️ Favorites<br/><<AggregateRoot>>"]
            
            %% Entities
            RefreshToken["🎫 Refresh Token<br/><<Entity>>"]
            DeviceToken["📱 Device Token<br/><<Entity>>"]
            ActivityEntry["📝 Activity Entry<br/><<Entity>>"]
            Role["🎭 Role<br/><<Entity>>"]
            
            %% Value Objects
            UserId["🆔 User ID<br/><<ValueObject>>"]
            Email["📧 Email<br/><<ValueObject>>"]
            UserName["👤 User Name<br/><<ValueObject>>"]
            
            %% Domain Services
            UserValidationService["✅ User Validation<br/><<DomainService>>"]
            ActivityTrackingService["📊 Activity Tracking<br/><<DomainService>>"]
        end
        
        %% ===== PORTS (DOMAIN INTERFACES) =====
        subgraph UserPorts ["Ports <<Port>>"]
            direction TB
            
            %% Repository Ports
            IUserRepo["📊 IUserRepository<br/><<Port>>"]
            IActivityRepo["📊 IActivityRepository<br/><<Port>>"]
            IFavoriteRepo["❤️ IFavoriteRepository<br/><<Port>>"]
            ITokenRepo["🎫 ITokenRepository<br/><<Port>>"]
            IRoleRepo["🎭 IRoleRepository<br/><<Port>>"]
            
            %% Service Ports
            IPasswordHasher["🔒 IPasswordHasher<br/><<Port>>"]
            IEmailService["📧 IEmailService<br/><<Port>>"]
            IStorageService["💾 IStorageService<br/><<Port>>"]
            INotificationService["🔔 INotificationService<br/><<Port>>"]
        end
        
        %% ===== APPLICATION LAYER =====
        subgraph UserApplication ["Application Layer <<Application>>"]
            direction TB
            
            %% Commands
            subgraph UserCommands ["Commands"]
                CreateUserCmd["➕ Create User<br/><<Command>>"]
                UpdateUserCmd["✏️ Update User<br/><<Command>>"]
                DeactivateUserCmd["🚫 Deactivate User<br/><<Command>>"]
                ChangePasswordCmd["🔒 Change Password<br/><<Command>>"]
                AddFavoriteCmd["❤️ Add Favorite<br/><<Command>>"]
                RecordActivityCmd["📊 Record Activity<br/><<Command>>"]
            end
            
            %% Queries
            subgraph UserQueries ["Queries"]
                GetUserQuery["👤 Get User<br/><<Query>>"]
                GetUserActivityQuery["📊 Get Activity<br/><<Query>>"]
                GetUserFavoritesQuery["❤️ Get Favorites<br/><<Query>>"]
                GetUserStatsQuery["📈 Get Stats<br/><<Query>>"]
            end
            
            %% Sagas
            subgraph UserSagas ["Sagas"]
                UserOnboardingSaga["🎯 User Onboarding<br/><<Saga>>"]
                UserDeactivationSaga["🚫 User Deactivation<br/><<Saga>>"]
            end
        end
        
        %% ===== INFRASTRUCTURE LAYER (ADAPTERS) =====
        subgraph UserAdapters ["Infrastructure Layer <<Adapter>>"]
            direction TB
            
            %% Repository Adapters
            subgraph RepositoryAdapters ["Repository Adapters"]
                MongoUserRepo["🗄️ Mongo User Repository<br/><<RepositoryAdapter>>"]
                MongoActivityRepo["🗄️ Mongo Activity Repository<br/><<RepositoryAdapter>>"]
                MongoFavoriteRepo["🗄️ Mongo Favorite Repository<br/><<RepositoryAdapter>>"]
                RedisTokenRepo["🔴 Redis Token Repository<br/><<RepositoryAdapter>>"]
                MongoRoleRepo["🗄️ Mongo Role Repository<br/><<RepositoryAdapter>>"]
            end
            
            %% Service Adapters
            subgraph ServiceAdapters ["Service Adapters"]
                BcryptHasher["🔐 Bcrypt Hasher<br/><<SecurityAdapter>>"]
                SendGridEmail["📧 SendGrid Email<br/><<EmailAdapter>>"]
                S3Storage["☁️ S3 Storage<br/><<StorageAdapter>>"]
                FirebasePush["📱 Firebase Push<br/><<NotificationAdapter>>"]
            end
            
            %% Cache Adapters
            subgraph CacheAdapters ["Cache Adapters"]
                UserProfileCache["💾 User Profile Cache<br/><<CacheAdapter>>"]
                ActivityCache["💾 Activity Cache<br/><<CacheAdapter>>"]
            end
        end
    end
    
    %% ===== EXTERNAL SYSTEMS =====
    subgraph UserExternal ["🌐 External Systems"]
        MongoDB["🗄️ MongoDB<br/><<Database>>"]
        RedisCache["🔴 Redis<br/><<Cache>>"]
        S3Bucket["☁️ S3 Bucket<br/><<Storage>>"]
        SendGridAPI["📧 SendGrid API<br/><<EmailService>>"]
        FirebaseAPI["📱 Firebase API<br/><<PushService>>"]
    end
    
    %% ===== EVENTS =====
    subgraph UserEvents ["📨 Domain Events"]
        UserRegisteredEvent["👤 User Registered<br/><<DomainEvent>>"]
        UserUpdatedEvent["✏️ User Updated<br/><<DomainEvent>>"]
        UserDeactivatedEvent["🚫 User Deactivated<br/><<DomainEvent>>"]
        ActivityRecordedEvent["📊 Activity Recorded<br/><<DomainEvent>>"]
        FavoriteAddedEvent["❤️ Favorite Added<br/><<DomainEvent>>"]
    end
    
    %% ===== READ MODELS =====
    subgraph UserReadModels ["📊 Read Models"]
        UserProfileRM["👤 User Profile<br/><<ReadModel>>"]
        UserDashboardRM["📊 User Dashboard<br/><<ReadModel>>"]
        UserActivityRM["📈 User Activity<br/><<ReadModel>>"]
        UserStatsRM["📊 User Stats<br/><<ReadModel>>"]
    end
    
    %% ===== RELATIONSHIPS =====
    
    %% Domain to Ports (Dependency Inversion)
    User -->|uses| IUserRepo
    User -->|uses| IPasswordHasher
    User -->|uses| IEmailService
    UserActivity -->|uses| IActivityRepo
    UserFavorites -->|uses| IFavoriteRepo
    
    %% Application to Domain
    UserCommands -->|orchestrates| User
    UserCommands -->|orchestrates| UserActivity
    UserQueries -->|reads| User
    UserQueries -->|reads| UserActivity
    
    %% Ports to Adapters (Implementation)
    IUserRepo -.->|implements| MongoUserRepo
    IActivityRepo -.->|implements| MongoActivityRepo
    IFavoriteRepo -.->|implements| MongoFavoriteRepo
    ITokenRepo -.->|implements| RedisTokenRepo
    IRoleRepo -.->|implements| MongoRoleRepo
    IPasswordHasher -.->|implements| BcryptHasher
    IEmailService -.->|implements| SendGridEmail
    IStorageService -.->|implements| S3Storage
    INotificationService -.->|implements| FirebasePush
    
    %% Adapters to External Systems
    MongoUserRepo -->|connects| MongoDB
    MongoActivityRepo -->|connects| MongoDB
    MongoFavoriteRepo -->|connects| MongoDB
    MongoRoleRepo -->|connects| MongoDB
    RedisTokenRepo -->|connects| RedisCache
    UserProfileCache -->|connects| RedisCache
    ActivityCache -->|connects| RedisCache
    S3Storage -->|connects| S3Bucket
    SendGridEmail -->|connects| SendGridAPI
    FirebasePush -->|connects| FirebaseAPI
    
    %% Domain Events
    User -.->|publishes| UserRegisteredEvent
    User -.->|publishes| UserUpdatedEvent
    User -.->|publishes| UserDeactivatedEvent
    UserActivity -.->|publishes| ActivityRecordedEvent
    UserFavorites -.->|publishes| FavoriteAddedEvent
    
    %% Event to Read Models
    UserRegisteredEvent -.->|projects to| UserProfileRM
    UserUpdatedEvent -.->|projects to| UserProfileRM
    ActivityRecordedEvent -.->|projects to| UserActivityRM
    ActivityRecordedEvent -.->|projects to| UserDashboardRM
    
    %% Sagas
    UserOnboardingSaga -.->|listens to| UserRegisteredEvent
    UserDeactivationSaga -.->|listens to| UserDeactivatedEvent
    
    %% ===== STYLING =====
    classDef aggregate fill:#e1f5fe,stroke:#01579b,stroke-width:3px
    classDef entity fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef valueObject fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef port fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef adapter fill:#fff8e1,stroke:#f57f17,stroke-width:2px
    classDef external fill:#fafafa,stroke:#424242,stroke-width:2px
    classDef command fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef query fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef event fill:#f1f8e9,stroke:#33691e,stroke-width:2px
    classDef readModel fill:#e0f2f1,stroke:#00695c,stroke-width:2px
    
    class User,UserActivity,UserFavorites aggregate
    class RefreshToken,DeviceToken,ActivityEntry,Role entity
    class UserId,Email,UserName valueObject
    class IUserRepo,IActivityRepo,IFavoriteRepo,ITokenRepo,IRoleRepo,IPasswordHasher,IEmailService,IStorageService,INotificationService port
    class MongoUserRepo,MongoActivityRepo,MongoFavoriteRepo,RedisTokenRepo,MongoRoleRepo,BcryptHasher,SendGridEmail,S3Storage,FirebasePush,UserProfileCache,ActivityCache adapter
    class MongoDB,RedisCache,S3Bucket,SendGridAPI,FirebaseAPI external
    class CreateUserCmd,UpdateUserCmd,DeactivateUserCmd,ChangePasswordCmd,AddFavoriteCmd,RecordActivityCmd command
    class GetUserQuery,GetUserActivityQuery,GetUserFavoritesQuery,GetUserStatsQuery query
    class UserRegisteredEvent,UserUpdatedEvent,UserDeactivatedEvent,ActivityRecordedEvent,FavoriteAddedEvent event
    class UserProfileRM,UserDashboardRM,UserActivityRM,UserStatsRM readModel